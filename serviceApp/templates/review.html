{% extends 'base.html' %}

{% block content %}

    <!-- 1 RATING/WRITE REVIEW -->
    <div><center>
        <h1 style="color: #231F20; padding: 30px;">REVIEWS</h1>
    </center></div>
    <div class="container">
        <div class="stats">
            <h2>STATS</h2>
            <p>TOTAL REVIEWS : <span id="totalReviews">0</span></p>
            <p>AVERAGE RATING : <span id="averageRating">0</span>/5</p>
            <div class="rating-chart">
                <div class="rating-bar">
                    <span>5 <i class="fas fa-star"></i>
                    </span>
                    <div class="bar">
                        <div class="fill" id="rating5" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="rating-bar">
                    <span>4 <i class="fas fa-star"></i>
                    </span>
                    <div class="bar">
                        <div class="fill" id="rating4" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="rating-bar">
                    <span>3 <i class="fas fa-star"></i>
                    </span>
                    <div class="bar">
                        <div class="fill" id="rating3" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="rating-bar">
                    <span>2 <i class="fas fa-star"></i>
                    </span>
                    <div class="bar">
                        <div class="fill" id="rating2" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="rating-bar">
                    <span>1 <i class="fas fa-star"></i>
                    </span>
                    <div class="bar">
                        <div class="fill" id="rating1" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="review-form">
            <h2>WRITE YOUR REVIEW</h2>
            <form id="reviewForm">
                <textarea id="reviewText" rows="5" placeholder="Write your review" required></textarea>
                <div class="stars" id="formStars">
                    <span data-rating="1">&#9733;</span>
                    <span data-rating="2">&#9733;</span>
                    <span data-rating="3">&#9733;</span>
                    <span data-rating="4">&#9733;</span>
                    <span data-rating="5">&#9733;</span>
                </div>
                <p>RATING: <span id="selectedRating">0</span>/5</p>
                <button type="submit">SUBMIT REVIEW</button>
            </form>
        </div>
    </div>

    <script>
        let selectedRating = 0;

        document.querySelectorAll(".stars span").forEach(star => {
            star.addEventListener("click", function() {
                selectedRating = this.getAttribute("data-rating");
                document.getElementById("selectedRating").innerText = selectedRating;

                document.querySelectorAll(".stars span").forEach(s => s.classList.remove("active"));
                for (let i = 0; i < selectedRating; i++) {
                    document.querySelectorAll(".stars span")[i].classList.add("active");
                }
            });
        });

        document.getElementById("reviewForm").addEventListener("submit", function(e) {
            e.preventDefault();

            const ratingElement = document.getElementById("selectedRating");
            const reviewText = document.getElementById("reviewText").value;
            const rating = ratingElement ? parseInt(ratingElement.innerText) : 0;

            if (!rating || rating < 1 || rating > 5) {
                alert("Please select a valid rating!");
                return;
            }

            fetch("/submit_review/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                body: JSON.stringify({ rating: rating, comments: reviewText }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("Error: " + data.error);
                } else {
                    alert("Review submitted successfully!");
                    loadStats();
                }
            })
            .catch(error => console.error("Error:", error));
        });

        function loadStats() {
            fetch("/get_review_stats/")
                .then(response => response.json())
                .then(data => {
                    document.getElementById("totalReviews").innerText = data.total_reviews;
                    document.getElementById("averageRating").innerText = data.avg_rating;

                    for (let i = 1; i <= 5; i++) {
                        let percentage = (data.rating_counts[i] / data.total_reviews) * 100 || 0;
                        document.getElementById("rating" + i).style.width = percentage + "%";
                    }
                })
                .catch(error => console.error("Error:", error));
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                document.cookie.split(';').forEach(cookie => {
                    let trimmed = cookie.trim();
                    if (trimmed.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(trimmed.substring(name.length + 1));
                    }
                });
            }
            return cookieValue;
        }

        document.addEventListener("DOMContentLoaded", loadStats);
        document.querySelectorAll("#formStars span").forEach(star => {
            star.addEventListener("click", function () {
                const rating = this.getAttribute("data-rating");
                document.getElementById("selectedRating").innerText = rating;
                console.log("‚≠ê Selected Rating:", rating);
            });
        });
    </script>

    <!-- 2 -->

    <section id="testimonials">

        <div class="testimonial-heading">
        </div>

        <div style="margin-top: -100px;" class="testimonial-box-container">

            <div class="testimonial-box">
                <div class="box-top">
                    <div class="profile">
                        <div class="profile-img">
                            <img
                                src="https://img.freepik.com/premium-vector/portrait-beautiful-women-round-frame-avatar-female-character-isolated-white-background_559729-210.jpg?w=740" />
                        </div>
                        <div class="name-user">
                            <strong>Noah Wood</strong>
                            <span>27 January 2025</span>
                        </div>
                    </div>
                    <div class="reviews">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                    </div>
                </div>
                <div class="client-comment">
                    <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Exercitationem, quaerat quis?
                        Provident temporibus architecto asperiores nobis maiores nisi a. Quae doloribus ipsum
                        aliquam tenetur voluptates incidunt blanditiis sed atque cumque.</p>
                </div>
            </div>
        </div>
    </section>
    <br>

    <script>
        function loadReviews() {
            fetch("/get_reviews/")
                .then(response => response.json())
                .then(data => {
                    console.log("üì• Reviews Data:", data);
                    const reviewContainer = document.querySelector(".testimonial-box-container");
                    reviewContainer.innerHTML = ""; 

                    data.reviews.forEach(review => {
                        const reviewHTML = `
                            <div class="testimonial-box">
                                <div class="box-top">
                                    <div class="profile">
                                        <div class="profile-img">
                                            <img src="${review.profile_img}" />
                                        </div>
                                        <div class="name-user">
                                            <strong>${review.name}</strong>  <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
                                            <span>${review.date}</span>
                                        </div>
                                    </div>
                                    <div class="reviews">
                                        ${generateStars(review.rating)}
                                    </div>
                                </div>
                                <div class="client-comment">
                                    <p>${review.comment}</p>
                                </div>
                            </div>
                        `;
                        reviewContainer.innerHTML += reviewHTML;
                    });
                })
                .catch(error => console.error("Error fetching reviews:", error));
        }
        function generateStars(rating) {
            let starsHTML = "";
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    starsHTML += '<i class="fas fa-star"></i>';
                } else {
                    starsHTML += '<i class="far fa-star"></i>';
                }
            }
            return starsHTML;
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
        document.addEventListener("DOMContentLoaded", loadReviews);
    </script>
    <!-- PAGE-NAV -->
    <nav aria-label="Page navigation ">
        <ul class="pagination">
            <li class="page-item">
                <a class="page-link" href="#" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            <li class="page-item"><a class="page-link" href="#">1</a></li>
            <li class="page-item"><a class="page-link" href="#">2</a></li>
            <li class="page-item"><a class="page-link" href="#">3</a></li>
            <li class="page-item">
                <a class="page-link" href="#" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        </ul>
    </nav>
    <br>

    <script src='https://kit.fontawesome.com/c8e4d183c2.js'></script>


    <footer>
        <a class="logo" style="color: #DAC494;     text-shadow: rgb(158, 158, 158) 1px 0 10px;
font-size: 25px; margin-top: 50px; margin-left: 20px;" href="./index">MASSAGE & SPA</a>
        <div class="nav">
            <div class="links">
                <ul>
                    <li style=" color: #DAC494; font-size: 18px; font-weight: bold;">Link</li>
                    <li><a href="/">Home</a></li>
                    <li><a href="/service">Services</a></li>
                    <li><a href="/review">Review</a></li>
                    <li><a href="/account">Account</a></li>
                </ul>
            </div>
            <div class="social">
                <ul>
                    <li style="color: #DAC494; font-size: 18px; font-weight: bold;">Contact</li>
                    <li>Email : @gmail.com</li>
                    <li> Phone : 08812345678</li>
                    <li> Address : 123 kosumpisai</li>
                </ul>
            </div>

            <div class="opening">
                <ul>
                    <li style="color: #DAC494; font-size: 18px; font-weight: bold;">Opening Time</li>
                    <li>Open 7 days a week </li>
                    <li>10:00 - 00:00</li>

                </ul>
            </div>
        </div>
    </footer>
{%endblock%}